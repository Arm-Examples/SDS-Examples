# About this application

This is a standalone test application that uses [SDS Recorder](https://github.com/ARM-software/SDS-Framework)
to record test input and output data.

This example is pre-configured for STMicroelectronics [STM32H735G-DK](https://www.st.com/en/evaluation-tools/stm32h735g-dk.html) board.

It uses the Ethernet interface to record the data on the host computer.

Test input data:
- test data generated by the application to simulate IMU sensor data

Test output data:
- test data generated by the application to simulate the ML output data

Examples of 7 seconds of recorded data are available in the `./SDS Recordings` subfolder,
which also contains the `.sds.yml` metadata files.

### Configuring stream buffering

The SDS framework implements stream buffering, which must be configured correctly in order
to achive better performance. Therefore, the stream buffer must be large enough to store at least
some data records. If the stream buffer is larger, more data records are buffered before they are
written to the output device. If the stream buffer is smaller, less data is buffered and the data
is written more frequently. In this example, the buffer sizes are selected so that at least **20 data
records** are buffered in order to achieve optimum performance.

The buffer **threshold** specifies a certain value above which the recorded data streams trigger
internal network transmission or writing to a file. The threshold value should therefore be a few
data records below the buffer size.

The following table shows the values configured in the `DataTest` example:

Record size   | Record interval  | Buffer size  | Threshold
:-------------|:-----------------|:-------------|:------------  
360 bytes     | 10 ms            | 8192 bytes   | 7400 bytes    
40 bytes      | 10 ms            | 1536 bytes   | 1400 bytes

**Note**
- The SDS recorder adds an internal header to each data record, which increases the size of
  the recorded data.

### Validation of recorded data

Recorded data can be viewed with the [SDS-View](https://github.com/ARM-software/SDS-Framework/tree/main/utilities/SDS-View)
utility program. This tool reads in the data and
outputs a time-based diagram. You must also provide the tool with a metadata description file
`<name>.sds.yml`.The recordings are processed and decoded based on the description in this file.

### Measuring the CPU load

The idle time is the time during which the CPU is not executing the application code. This means that it executes
the code of the idle thread, incrementing the `idle_cnt` counter. The code for incrementing the idle counter is located
in the `osRtxIdle_Thread`:

```c
__NO_RETURN void osRtxIdleThread(void *argument) {
  (void)argument;

  for (;;) {
    idle_cnt++;
  }
}
```

The counter is incremented for one second, then the idle factor is calculated as the ratio between the idle counter
and the measured idle counter for the system without load `no_load_cnt` and displayed on the debug console:

```c
if (++cnt == 10U) {
  printf("%d%% idle\n",(idle_cnt - prev_cnt) / (no_load_cnt / 100U));
  prev_cnt = idle_cnt;
  cnt      = 0U;
}
```

For a correct measurement, the loop interval must be exact, which is why the `osDelayUntil` function is used to generate
time intervals in the measurement loop:

```c
timestamp = osKernelGetTickCount();
for (;;) {
   :
  timestamp += 100U;
  osDelayUntil(timestamp);
}
```
